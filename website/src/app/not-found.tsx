'use client';
import { useEffect } from 'react';

export default function NotFound() {
  const nfCss = ".nf-err-code{font-family:'Press Start 2P',monospace;font-size:3.5rem;font-weight:900;line-height:1.3;color:#7c3aed;text-shadow:0 0 40px rgba(124,58,237,.5);text-align:center}.nf-tagline{font-family:'Press Start 2P',monospace;font-size:.45rem;line-height:2.2;color:#64748b;text-align:center}#nf-game-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:8px;width:100%;max-width:540px}#nf-hud{width:100%;max-width:480px;display:flex;justify-content:space-between;align-items:center;padding:6px 12px;background:#0f0f1a;border:1px solid rgba(124,58,237,0.2);border-radius:8px}#nf-hud span{font-family:'Press Start 2P',monospace;font-size:.44rem;letter-spacing:.04em;color:#a78bfa}#nf-s-lives{font-size:1rem;color:#f43f5e;letter-spacing:2px}#nf-gc{display:block;border:2px solid rgba(124,58,237,0.2);border-radius:8px;cursor:none;touch-action:none;background:#060612;image-rendering:pixelated}#nf-game-hint{font-size:.75rem;color:#64748b;font-family:monospace;text-align:center;padding:2px 0}#nf-sw-game{background:transparent;border:1.5px solid rgba(124,58,237,0.45);border-radius:6px;padding:10px 24px;font-family:'Press Start 2P',monospace;font-size:.5rem;color:#a78bfa;letter-spacing:.1em;cursor:pointer;transition:color .15s,border-color .15s;margin-top:2px;position:relative;z-index:15}#nf-sw-game:hover{color:#c4b5fd;border-color:#7c3aed}#nf-overlay{display:none;position:absolute;inset:0;background:rgba(0,0,0,.88);z-index:10;align-items:center;justify-content:center;border-radius:8px}#nf-ov-box{background:#0f0f1a;border:1px solid #7c3aed;border-radius:16px;padding:28px 32px;text-align:center;display:flex;flex-direction:column;gap:12px;min-width:260px;max-height:calc(100% - 20px);overflow-y:auto;box-shadow:0 0 60px rgba(124,58,237,.4)}#nf-ov-title{font-family:'Press Start 2P',monospace;font-size:1.1rem;font-weight:900;color:#a78bfa;letter-spacing:.06em}#nf-ov-score{font-family:'Press Start 2P',monospace;font-size:.75rem;font-weight:700;color:#e2e8f0}.nf-ov-hi{font-family:'Press Start 2P',monospace;font-size:.58rem;color:#a78bfa}.nf-ov-hi.new-hi{color:#c4b5fd;font-size:1.1rem;font-weight:700;animation:nf-pulse 1s ease-in-out infinite alternate}@keyframes nf-pulse{from{text-shadow:0 0 8px #a78bfa}to{text-shadow:0 0 24px #7c3aed}}#nf-ov-play{background:#7c3aed;color:#fff;border:none;border-radius:8px;padding:11px 24px;font-family:'Press Start 2P',monospace;font-size:.5rem;font-weight:700;cursor:pointer;letter-spacing:.08em;transition:background .15s,color .15s}#nf-ov-play:hover{background:#5b21b6;color:#fff}#nf-ov-home{font-family:'Press Start 2P',monospace;color:#4b5563;font-size:.4rem;text-decoration:none}#nf-ov-home:hover{color:#9ca3af}#nf-ov-scores table{width:100%;border-collapse:collapse;font-size:.78rem;font-family:monospace}#nf-ov-scores thead th{color:#7c3aed;font-size:.68rem;letter-spacing:.08em;text-transform:uppercase;padding:0 4px 4px;text-align:left}#nf-ov-scores thead th:last-child{text-align:right}#nf-ov-scores tbody tr{border-top:1px solid rgba(124,58,237,0.2)}#nf-ov-scores tbody td{padding:3px 4px;color:#64748b}#nf-ov-scores tbody td:first-child{color:#a78bfa;font-weight:700;width:2em}#nf-ov-scores tbody td:last-child{text-align:right;color:#e2e8f0}@media(max-width:520px){#nf-gc{width:100vw !important;height:100vw !important}}";

  useEffect(() => {
    const C1 = '#7c3aed';
    const C2 = '#a78bfa';
    const C3 = '#5b21b6';
    const C_RGB = '124,58,237';
    const CSS_CANVAS_BG = '#060612';
    const HI_SCORE_KEY = 'gs404_hi';
    let raf: number | null = null;
    let mounted = true;
    const K: Record<string, boolean> = {};
    const onKeyDown = (e: KeyboardEvent) => { K[e.key]=true;K[e.code]=true;if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].indexOf(e.key)>-1)e.preventDefault(); };
    const onKeyUp = (e: KeyboardEvent) => { K[e.key]=false;K[e.code]=false; };
    document.addEventListener('keydown', onKeyDown as EventListener);
    document.addEventListener('keyup', onKeyUp as EventListener);

    const _sf1=fetch('/sprites.json').then((r:any)=>r.json()).catch(()=>({}));const _sf2=fetch('/game-sprites.json').then((r:any)=>r.json()).catch(()=>({}));Promise.all([_sf1,_sf2]).then(([SD1,SD2]:any[])=>{
      if(!mounted)return;
      const SD:Record<string,string>={...(SD1||{}), ...(SD2||{})};const IMG:Record<string,HTMLImageElement>={};const _keys=Object.keys(SD||{});let _loaded=0;
      function tryReady(){if(++_loaded>=(_keys.length||1))onReady();}
      if(_keys.length===0)setTimeout(onReady,0);else _keys.forEach(function(k){IMG[k]=new Image();IMG[k].onload=tryReady;IMG[k].onerror=tryReady;IMG[k].src=SD[k];});
      const gc=document.getElementById('nf-gc') as HTMLCanvasElement|null;if(!gc)return;
      const ctx=gc.getContext('2d')!;const CW=480,CH=480;gc.width=CW;gc.height=CH;
      const px=Math.min(480,window.innerWidth-24);gc.style.width=px+'px';gc.style.height=px+'px';
      const ALL_GAMES=['nes'];let gameIdx=0;let GAME=ALL_GAMES[gameIdx];
      const HINTS:Record<string,string>={shooter:'<< >> to move  |  Auto-fires',breakout:'Mouse / Touch to move paddle  |  SPACE to launch',snake:'Arrow keys or WASD',void:'\u2191 \u2193 or mouse to fly  |  Auto-fires',runner:'SPACE / \u2191 to jump  |  \u2193 to duck',asteroids:'\u2190 \u2192 rotate  |  \u2191 thrust  |  SPACE shoot',nes:'Z=A  X=B  Enter=Start  Arrows=Move'};
      const hintEl=document.getElementById('nf-game-hint');if(hintEl)hintEl.textContent=HINTS[GAME];
      const _TOP_KEY=HI_SCORE_KEY+'_top',_TOP_MAX=5;
      function loadTopScores():number[]{try{return JSON.parse(localStorage.getItem(_TOP_KEY)||'[]');}catch(e){return[];}}
      function saveTopScore(s:number):number[]{if(!s||s<=0)return loadTopScores();let tops=loadTopScores();tops.push(s);tops.sort((a,b)=>b-a);tops=tops.slice(0,_TOP_MAX);localStorage.setItem(_TOP_KEY,JSON.stringify(tops));return tops;}
      function renderLeaderboard(tops:number[],newScore:number){const el=document.getElementById('nf-ov-scores');if(!tops||tops.length===0||!el){if(el)el.innerHTML='';return;}const rows=tops.map((v,i)=>{const isNew=v===newScore&&newScore>0;const rc=(i===0?' ov-rank-1':'')+(isNew?' ov-new':'');return'<tr class="'+rc+'"><td>#'+(i+1)+'</td><td style="padding:3px 4px">'+(isNew?'YOU':'---')+'</td><td>'+v.toLocaleString()+'</td></tr>';}).join('');el.innerHTML='<table><thead><tr><th>#</th><th>Player</th><th>Score</th></tr></thead><tbody>'+rows+'</tbody></table>';}
      let score=0,hiScore=Math.max(parseInt(localStorage.getItem(HI_SCORE_KEY)||'0',10),loadTopScores()[0]||0),lives=3,combo=0,comboTime=0,gameOver=false,lastT=0,mouseX=CW/2,mouseY=CH/2;
      gc.addEventListener('mousemove',function(e){const r=gc.getBoundingClientRect();mouseX=(e.clientX-r.left)*(CW/r.width);mouseY=(e.clientY-r.top)*(CH/r.height);});
      gc.addEventListener('touchmove',function(e){e.preventDefault();const r=gc.getBoundingClientRect();mouseX=((e as TouchEvent).touches[0].clientX-r.left)*(CW/r.width);},{passive:false} as any);
      gc.addEventListener('click',function(){if(GAME==='breakout'&&!bLaunched){K[' ']=true;setTimeout(function(){K[' ']=false;},80);}});
      let _tx0=0,_ty0=0;
      gc.addEventListener('touchstart',function(e){_tx0=(e as TouchEvent).touches[0].clientX;_ty0=(e as TouchEvent).touches[0].clientY;},{passive:true} as any);
      gc.addEventListener('touchend',function(e){const dx=(e as TouchEvent).changedTouches[0].clientX-_tx0,dy=(e as TouchEvent).changedTouches[0].clientY-_ty0;if(Math.abs(dx)<10&&Math.abs(dy)<10)return;if(GAME==='snake'){if(Math.abs(dx)>Math.abs(dy)){if(dx>0&&snDir.x===0)snNextDir={x:1,y:0};if(dx<0&&snDir.x===0)snNextDir={x:-1,y:0};}else{if(dy>0&&snDir.y===0)snNextDir={x:0,y:1};if(dy<0&&snDir.y===0)snNextDir={x:0,y:-1};}}},{passive:true} as any);
      function updateHUD(){const sc=document.getElementById('nf-s-score');if(sc)sc.textContent='SCORE '+score;const hi=document.getElementById('nf-s-hi');if(hi)hi.textContent='BEST '+hiScore;const lv=document.getElementById('nf-s-lives');if(lv)lv.textContent='\u2665'.repeat(Math.max(0,lives))+'\u2661'.repeat(Math.max(0,3-lives));}
      function addScore(pts:number){comboTime=4;combo++;const mult=combo>=5?2:1;score+=pts*mult;if(score>hiScore){hiScore=score;localStorage.setItem(HI_SCORE_KEY,String(hiScore));}updateHUD();}
      function showOverlay(_won:boolean){gameOver=true;const tops=saveTopScore(score);const isNew=score>0&&score>=hiScore;const te=document.getElementById('nf-ov-title');if(te)te.textContent=_won?'YOU WIN!':'GAME OVER';const se=document.getElementById('nf-ov-score');if(se)se.textContent='Score: '+score.toLocaleString();const he=document.getElementById('nf-ov-hi');if(he){if(isNew){he.textContent='NEW HIGH SCORE!';he.className='nf-ov-hi new-hi';}else{he.textContent='Best: '+hiScore.toLocaleString();he.className='nf-ov-hi';}}renderLeaderboard(tops,score);const ov=document.getElementById('nf-overlay');if(ov)ov.style.display='flex';}
      function restartGame(){const ov=document.getElementById('nf-overlay');if(ov)ov.style.display='none';score=0;lives=3;combo=0;comboTime=0;gameOver=false;updateHUD();if(raf!==null){cancelAnimationFrame(raf);raf=null;}if(GAME==='shooter')startShooter();else if(GAME==='breakout')startBreakout();else if(GAME==='snake')startSnake();else if(GAME==='void')startVoid();else if(GAME==='runner')startRunner();else if(GAME==='asteroids')startAsteroids();else if(GAME==='nes')startNes();lastT=performance.now();raf=requestAnimationFrame(loop);}
      const playBtn=document.getElementById('nf-ov-play');if(playBtn)playBtn.addEventListener('click',restartGame);
      const swBtn=document.getElementById('nf-sw-game');if(swBtn)swBtn.addEventListener('click',function(){gameIdx=(gameIdx+1)%ALL_GAMES.length;GAME=ALL_GAMES[gameIdx];const hEl=document.getElementById('nf-game-hint');if(hEl)hEl.textContent=HINTS[GAME];const ov=document.getElementById('nf-overlay');if(ov)ov.style.display='none';score=0;lives=3;combo=0;comboTime=0;gameOver=false;updateHUD();if(raf!==null){cancelAnimationFrame(raf);raf=null;}if(GAME==='shooter')startShooter();else if(GAME==='breakout')startBreakout();else if(GAME==='snake')startSnake();else if(GAME==='void')startVoid();else if(GAME==='runner')startRunner();else if(GAME==='asteroids')startAsteroids();else if(GAME==='nes')startNes();lastT=performance.now();raf=requestAnimationFrame(loop);});
      function onReady(){if(mounted)restartGame();}
      function loop(ts:number){if(gameOver)return;const dt=Math.min((ts-lastT)/1000,0.05);lastT=ts;comboTime-=dt;if(comboTime<=0){comboTime=0;combo=0;}if(GAME==='shooter')tickShooter(dt);else if(GAME==='breakout')tickBreakout(dt);else if(GAME==='snake')tickSnake(dt);else if(GAME==='void')tickVoid(dt);else if(GAME==='runner')tickRunner(dt);else if(GAME==='asteroids')tickAsteroids(dt);else if(GAME==='nes')tickNes(dt);raf=requestAnimationFrame(loop);}
      let ship:any,sBullets:any[],eBullets:any[],sEnemies:any[],sExplosions:any[],sStars:any[],sWave:number,sWaveCooldown:number,sShootTimer:number,sMoveDir:number;
      function startShooter(){ship={x:CW/2,y:CH-52,iframes:0};sBullets=[];eBullets=[];sEnemies=[];sExplosions=[];sStars=[];for(let i=0;i<80;i++)sStars.push({x:Math.random()*CW,y:Math.random()*CH,s:Math.random()*2+0.5,v:Math.random()*60+20,a:Math.random()*0.6+0.2});sWave=0;sWaveCooldown=0;sShootTimer=0;sMoveDir=1;spawnShooterWave();}
      function spawnShooterWave(){sWave++;const cols=Math.min(3+sWave,8),rows=Math.min(1+Math.floor(sWave/2),4),types=['enemy1','enemy2','enemy3'];for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)sEnemies.push({x:60+c*Math.floor((CW-120)/(cols-1||1)),y:48+r*52,w:28,h:28,type:types[(r+c)%3],hp:(sWave>3&&(r+c)%3===0)?2:1});}
      function tickShooter(dt:number){for(let i=0;i<sStars.length;i++){sStars[i].y+=sStars[i].v*dt;if(sStars[i].y>CH)sStars[i].y=0;}const spd=260;if(K['ArrowLeft']||K['a']||K['A']||K['KeyA'])ship.x-=spd*dt;if(K['ArrowRight']||K['d']||K['D']||K['KeyD'])ship.x+=spd*dt;ship.x=Math.max(16,Math.min(CW-16,ship.x));if(ship.iframes>0)ship.iframes-=dt;sShootTimer-=dt;if(sShootTimer<=0){sShootTimer=0.22;sBullets.push({x:ship.x,y:ship.y-18});}if(sEnemies.length>0){const edx=sMoveDir*(40+sWave*5)*dt;let leftEdge=CW,rightEdge=0;for(let i=0;i<sEnemies.length;i++){sEnemies[i].x+=edx;leftEdge=Math.min(leftEdge,sEnemies[i].x-sEnemies[i].w/2);rightEdge=Math.max(rightEdge,sEnemies[i].x+sEnemies[i].w/2);}if(rightEdge>=CW-4||leftEdge<=4){sMoveDir*=-1;for(let i=0;i<sEnemies.length;i++)sEnemies[i].y+=14;}}if(sEnemies.length>0&&Math.random()<0.012*sEnemies.length*dt*60){const sh=sEnemies[Math.floor(Math.random()*sEnemies.length)];eBullets.push({x:sh.x,y:sh.y+sh.h/2+4,type:sh.type});}let nb:any[]=[];for(let i=0;i<sBullets.length;i++){sBullets[i].y-=(340+sWave*12)*dt;if(sBullets[i].y>-10)nb.push(sBullets[i]);}sBullets=nb;let nb3:any[]=[];for(let i=0;i<eBullets.length;i++){eBullets[i].y+=(200+sWave*8)*dt;if(eBullets[i].y<CH+10)nb3.push(eBullets[i]);}eBullets=nb3;const sE2:any[]=[];for(let ei=0;ei<sEnemies.length;ei++){const e2=sEnemies[ei];let hit=false;const sB2:any[]=[];for(let bi=0;bi<sBullets.length;bi++){const b=sBullets[bi];if(!hit&&Math.abs(b.x-e2.x)<e2.w/2+4&&Math.abs(b.y-e2.y)<e2.h/2+6){hit=true;e2.hp--;if(e2.hp<=0){addScore(10*sWave);sExplosions.push({x:e2.x,y:e2.y,r:e2.w*0.7,t:0,d:0.38,isP:false});}else{sExplosions.push({x:e2.x,y:e2.y,r:e2.w*0.4,t:0,d:0.2,isP:false});sE2.push(e2);}}else sB2.push(b);}sBullets=sB2;if(e2.hp>0&&!hit)sE2.push(e2);}sEnemies=sE2;const nb4:any[]=[];for(let i=0;i<eBullets.length;i++){const eb=eBullets[i];if(ship.iframes<=0&&Math.abs(eb.x-ship.x)<14&&Math.abs(eb.y-ship.y)<14){lives--;combo=0;ship.iframes=2.0;sExplosions.push({x:ship.x,y:ship.y,r:20,t:0,d:0.5,isP:true});updateHUD();if(lives<=0){drawShooter();showOverlay(false);return;}}else nb4.push(eb);}eBullets=nb4;for(let i=0;i<sEnemies.length;i++){if(sEnemies[i].y>CH-70&&ship.iframes<=0){lives--;combo=0;ship.iframes=2.0;updateHUD();if(lives<=0){drawShooter();showOverlay(false);return;}}}const ne:any[]=[];for(let i=0;i<sExplosions.length;i++){sExplosions[i].t+=dt;if(sExplosions[i].t<sExplosions[i].d)ne.push(sExplosions[i]);}sExplosions=ne;if(sEnemies.length===0){sWaveCooldown-=dt;if(sWaveCooldown<=0){sWaveCooldown=1.8;spawnShooterWave();}}else sWaveCooldown=1.8;drawShooter();}
      function drawShooter(){ctx.fillStyle=CSS_CANVAS_BG;ctx.fillRect(0,0,CW,CH);for(let i=0;i<sStars.length;i++){ctx.globalAlpha=sStars[i].a;ctx.fillStyle='#ffffff';ctx.fillRect(sStars[i].x,sStars[i].y,sStars[i].s,sStars[i].s);}ctx.globalAlpha=1;for(let i=0;i<eBullets.length;i++){const e=eBullets[i];const bIm=IMG[e.type];if(bIm&&bIm.complete&&bIm.naturalWidth>0){ctx.save();ctx.translate(e.x,e.y);ctx.rotate(Math.PI);ctx.drawImage(bIm,-4,-8,8,16);ctx.restore();}else{ctx.fillStyle='#f87171';ctx.fillRect(e.x-3,e.y-6,6,12);}}for(let i=0;i<sEnemies.length;i++){const e=sEnemies[i];const em=IMG[e.type];if(em&&em.complete&&em.naturalWidth>0){ctx.save();ctx.translate(e.x,e.y);ctx.rotate(Math.PI);ctx.drawImage(em,-e.w/2,-e.h/2,e.w,e.h);ctx.restore();}}for(let i=0;i<sBullets.length;i++){const pb=sBullets[i];if(IMG.bullet&&IMG.bullet.complete&&IMG.bullet.naturalWidth>0)ctx.drawImage(IMG.bullet,pb.x-4,pb.y-7,8,14);else{ctx.fillStyle=C2;ctx.fillRect(pb.x-2,pb.y-6,4,10);}}if(!(ship.iframes>0&&Math.floor(ship.iframes*8)%2===0)){if(IMG.player&&IMG.player.complete&&IMG.player.naturalWidth>0)ctx.drawImage(IMG.player,ship.x-16,ship.y-16,32,32);else{ctx.fillStyle=C2;ctx.fillRect(ship.x-8,ship.y-12,16,24);}}for(let i=0;i<sExplosions.length;i++){const e=sExplosions[i];const p=e.t/e.d;const er=e.r*(0.5+p*1.3);ctx.save();ctx.globalAlpha=(1-p)*0.9;const g=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,er);g.addColorStop(0,'#ffffff');g.addColorStop(0.25,e.isP?C1:'#fde047');g.addColorStop(0.6,e.isP?C3:'#f97316');g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(e.x,e.y,er,0,Math.PI*2);ctx.fill();ctx.restore();}if(combo>=5){ctx.font='bold 13px monospace';ctx.fillStyle=C2;ctx.fillText('x2 COMBO',ship.x-34,ship.y-46);}if(sEnemies.length===0&&sWaveCooldown>0){ctx.font='bold 26px monospace';ctx.fillStyle=C2;ctx.textAlign='center';ctx.fillText('WAVE '+sWave+' CLEAR!',CW/2,CH/2-12);ctx.font='14px monospace';ctx.fillStyle='#64748b';ctx.fillText('Next wave incoming...',CW/2,CH/2+16);ctx.textAlign='left';}}
      const BR_COLS=10,BR_ROWS=6,BR_BW=42,BR_BH=17,BR_PAD=4,BR_OX=Math.floor((CW-(BR_COLS*(BR_BW+BR_PAD)-BR_PAD))/2),BR_OY=52;
      const BR_COLORS:string[][]=[['#dc2626','#fca5a5'],['#c2410c','#fdba74'],['#b45309','#fcd34d'],['#15803d','#86efac'],['#1d4ed8','#93c5fd'],[C1,C2]];
      let bPaddle:any,bBall:any,bBricks:any[],bLevel:number,bLaunched:boolean;
      function startBreakout(){bLevel=1;bLaunched=false;bPaddle={x:CW/2,w:84,h:12,y:CH-30};bBall={x:CW/2,y:CH-52,r:7,vx:0,vy:0};buildBricks();}
      function buildBricks(){bBricks=[];for(let r=0;r<BR_ROWS;r++)for(let c=0;c<BR_COLS;c++){const hp=(r<4)?1:2;bBricks.push({x:BR_OX+c*(BR_BW+BR_PAD),y:BR_OY+r*(BR_BH+BR_PAD),w:BR_BW,h:BR_BH,hp,maxHp:hp,ci:r%BR_COLORS.length});}}
      function tickBreakout(dt:number){bPaddle.x+=(mouseX-bPaddle.x)*Math.min(1,dt*18);bPaddle.x=Math.max(bPaddle.w/2,Math.min(CW-bPaddle.w/2,bPaddle.x));if(!bLaunched){bBall.x=bPaddle.x;bBall.y=bPaddle.y-bPaddle.h/2-bBall.r-1;if(K[' ']||K['Space']||K['ArrowUp']){const ang=-Math.PI/2+(Math.random()-0.5)*0.7,spd2=300+bLevel*28;bBall.vx=Math.cos(ang)*spd2;bBall.vy=Math.sin(ang)*spd2;bLaunched=true;}drawBreakout();return;}let bx=bBall.x+bBall.vx*dt,by=bBall.y+bBall.vy*dt;if(bx-bBall.r<0){bx=bBall.r;bBall.vx=Math.abs(bBall.vx);}if(bx+bBall.r>CW){bx=CW-bBall.r;bBall.vx=-Math.abs(bBall.vx);}if(by-bBall.r<0){by=bBall.r;bBall.vy=Math.abs(bBall.vy);}const py0=bPaddle.y-bPaddle.h/2,py1=bPaddle.y+bPaddle.h/2,px0=bPaddle.x-bPaddle.w/2,px1=bPaddle.x+bPaddle.w/2;if(bBall.vy>0&&by+bBall.r>=py0&&by-bBall.r<=py1&&bx>=px0-bBall.r&&bx<=px1+bBall.r){by=py0-bBall.r;bBall.vy=-Math.abs(bBall.vy);const rel=(bx-bPaddle.x)/(bPaddle.w/2);bBall.vx=rel*360;const sp2=Math.sqrt(bBall.vx*bBall.vx+bBall.vy*bBall.vy),maxSp=500+bLevel*22;if(sp2>maxSp){bBall.vx*=maxSp/sp2;bBall.vy*=maxSp/sp2;}}if(by>CH+20){lives--;bLaunched=false;bBall.vx=0;bBall.vy=0;updateHUD();if(lives<=0){drawBreakout();showOverlay(false);return;}bBall.x=bPaddle.x;bBall.y=bPaddle.y-bPaddle.h/2-bBall.r-1;drawBreakout();return;}const nb2:any[]=[];for(let i=0;i<bBricks.length;i++){const br=bBricks[i],cx2=Math.max(br.x,Math.min(bx,br.x+br.w)),cy2=Math.max(br.y,Math.min(by,br.y+br.h)),ddx=bx-cx2,ddy=by-cy2;if(ddx*ddx+ddy*ddy<bBall.r*bBall.r){br.hp--;addScore(10);const ovX=bBall.r-Math.abs(ddx),ovY=bBall.r-Math.abs(ddy);if(Math.abs(ddx)<0.1||ovX<ovY)bBall.vx*=-1;else bBall.vy*=-1;if(br.hp>0)nb2.push(br);}else nb2.push(br);}bBricks=nb2;bBall.x=bx;bBall.y=by;if(bBricks.length===0){bLevel++;addScore(300);bLaunched=false;bBall.vx=0;bBall.vy=0;buildBricks();}drawBreakout();}
      function drawBreakout(){ctx.fillStyle=CSS_CANVAS_BG;ctx.fillRect(0,0,CW,CH);for(let i=0;i<bBricks.length;i++){const br=bBricks[i],ci=BR_COLORS[br.ci];ctx.fillStyle=ci[0];ctx.fillRect(br.x,br.y,br.w,br.h);ctx.fillStyle=ci[1];ctx.fillRect(br.x+1,br.y+1,br.w-2,5);if(br.hp<br.maxHp){ctx.strokeStyle='rgba(0,0,0,0.55)';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(br.x+br.w*0.25,br.y);ctx.lineTo(br.x+br.w*0.55,br.y+br.h);ctx.stroke();}}const ppx=bPaddle.x-bPaddle.w/2,ppy=bPaddle.y-bPaddle.h/2,rr=bPaddle.h/2,grad=ctx.createLinearGradient(ppx,ppy,ppx,ppy+bPaddle.h);grad.addColorStop(0,C2);grad.addColorStop(1,C3);ctx.fillStyle=grad;ctx.beginPath();ctx.moveTo(ppx+rr,ppy);ctx.lineTo(ppx+bPaddle.w-rr,ppy);ctx.arc(ppx+bPaddle.w-rr,ppy+rr,rr,-Math.PI/2,0);ctx.lineTo(ppx+bPaddle.w,ppy+bPaddle.h-rr);ctx.arc(ppx+bPaddle.w-rr,ppy+bPaddle.h-rr,rr,0,Math.PI/2);ctx.lineTo(ppx+rr,ppy+bPaddle.h);ctx.arc(ppx+rr,ppy+bPaddle.h-rr,rr,Math.PI/2,Math.PI);ctx.lineTo(ppx,ppy+rr);ctx.arc(ppx+rr,ppy+rr,rr,Math.PI,-Math.PI/2);ctx.closePath();ctx.fill();const bg2=ctx.createRadialGradient(bBall.x-2,bBall.y-2,0,bBall.x,bBall.y,bBall.r+4);bg2.addColorStop(0,'#ffffff');bg2.addColorStop(0.4,C2);bg2.addColorStop(0.8,C1);bg2.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=bg2;ctx.beginPath();ctx.arc(bBall.x,bBall.y,bBall.r+4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(bBall.x,bBall.y,bBall.r,0,Math.PI*2);ctx.fill();if(!bLaunched){ctx.fillStyle=C2;ctx.font='13px monospace';ctx.textAlign='center';ctx.fillText('SPACE or CLICK to launch',CW/2,bBall.y-20);ctx.textAlign='left';}ctx.fillStyle=C1;ctx.font='bold 12px monospace';ctx.fillText('LEVEL '+bLevel,8,22);}
      const SN_COLS=20,SN_ROWS=20;const SN_CW=Math.floor(CW/SN_COLS),SN_CH=Math.floor(CH/SN_ROWS);
      let snBody:any[],snDir:any,snNextDir:any,snFood:any,snTimer:number,snSpeed:number,snGrow:number;
      function startSnake(){snBody=[{x:10,y:10},{x:9,y:10},{x:8,y:10}];snDir={x:1,y:0};snNextDir={x:1,y:0};snFood=snSpawnFood();snSpeed=7;snTimer=0;snGrow=0;}
      function snSpawnFood(){let pos:any;do{pos={x:Math.floor(Math.random()*SN_COLS),y:Math.floor(Math.random()*SN_ROWS)};}while(snBody.some((s:any)=>s.x===pos.x&&s.y===pos.y));return pos;}
      function tickSnake(dt:number){if(K['ArrowUp']&&snDir.y===0)snNextDir={x:0,y:-1};if(K['ArrowDown']&&snDir.y===0)snNextDir={x:0,y:1};if(K['ArrowLeft']&&snDir.x===0)snNextDir={x:-1,y:0};if(K['ArrowRight']&&snDir.x===0)snNextDir={x:1,y:0};if((K['w']||K['W']||K['KeyW'])&&snDir.y===0)snNextDir={x:0,y:-1};if((K['s']||K['S']||K['KeyS'])&&snDir.y===0)snNextDir={x:0,y:1};if((K['a']||K['A']||K['KeyA'])&&snDir.x===0)snNextDir={x:-1,y:0};if((K['d']||K['D']||K['KeyD'])&&snDir.x===0)snNextDir={x:1,y:0};snTimer+=dt;const step=1/snSpeed;if(snTimer>=step){snTimer-=step;snDir=snNextDir;const head={x:snBody[0].x+snDir.x,y:snBody[0].y+snDir.y};if(head.x<0||head.x>=SN_COLS||head.y<0||head.y>=SN_ROWS){drawSnake();showOverlay(false);return;}for(let i=0;i<snBody.length;i++){if(snBody[i].x===head.x&&snBody[i].y===head.y){drawSnake();showOverlay(false);return;}}snBody.unshift(head);if(head.x===snFood.x&&head.y===snFood.y){addScore(10);snFood=snSpawnFood();snGrow+=2;if(score>0&&score%50===0)snSpeed=Math.min(snSpeed+1,20);}if(snGrow>0)snGrow--;else snBody.pop();}drawSnake();}
      function drawSnake(){ctx.fillStyle=CSS_CANVAS_BG;ctx.fillRect(0,0,CW,CH);ctx.strokeStyle='rgba('+C_RGB+',0.07)';ctx.lineWidth=0.5;for(let i=0;i<=SN_COLS;i++){ctx.beginPath();ctx.moveTo(i*SN_CW,0);ctx.lineTo(i*SN_CW,CH);ctx.stroke();}for(let i=0;i<=SN_ROWS;i++){ctx.beginPath();ctx.moveTo(0,i*SN_CH);ctx.lineTo(CW,i*SN_CH);ctx.stroke();}for(let i=0;i<snBody.length;i++){const seg=snBody[i];const bx2=seg.x*SN_CW,by2=seg.y*SN_CH,t=i/snBody.length;ctx.globalAlpha=1-t*0.45;ctx.fillStyle=i===0?C2:(i%2===0?C1:C3);ctx.fillRect(bx2+1,by2+1,SN_CW-2,SN_CH-2);ctx.globalAlpha=1;}const fx2=snFood.x*SN_CW+SN_CW/2,fy2=snFood.y*SN_CH+SN_CH/2,pulse=0.78+0.22*Math.sin(Date.now()*0.005),fr2=(SN_CW/2-1)*pulse,fg2=ctx.createRadialGradient(fx2-1,fy2-1,0,fx2,fy2,fr2);fg2.addColorStop(0,'#ffffff');fg2.addColorStop(0.35,C2);fg2.addColorStop(1,C1);ctx.fillStyle=fg2;ctx.beginPath();ctx.arc(fx2,fy2,fr2,0,Math.PI*2);ctx.fill();ctx.fillStyle=C3;ctx.font='bold 12px monospace';ctx.fillText('SPD '+snSpeed,8,22);}
      // ===== VOID GAUNTLET =====
      const VG_BG_KEYS=['sky_1','sky_2','sky_3','sky_4'];const VG_BG_SPEEDS=[18,45,80,130];const VG_BGW=853;
      let vgBGs:any[],vgPlayer:any,vgEnemies:any[],vgBullets:any[],vgWave:number,vgWaveCooldown:number;
      function spawnVoidWave(){vgWave++;const n=3+vgWave*2;for(let i=0;i<n;i++){const r2=Math.random();const t=vgWave<2?'vg_sc':r2<0.5?'vg_sc':r2<0.8?'vg_fr':'vg_dr';const hp=t==='vg_sc'?1:t==='vg_fr'?2:4;const spd=t==='vg_sc'?140:t==='vg_fr'?90:50;vgEnemies.push({x:CW+80+i*55,y:40+Math.random()*(CH-80),type:t,hp,maxHp:hp,spd,vx:-spd,phase:Math.random()*Math.PI*2,fireTimer:1.5+Math.random()*2,dest:false,destT:0});}}
      function startVoid(){vgBGs=VG_BG_KEYS.map(function(_:any,i:number){return{x:0,speed:VG_BG_SPEEDS[i]};});vgPlayer={x:80,y:CH/2,iframes:0,shootTimer:0};vgEnemies=[];vgBullets=[];vgWave=0;vgWaveCooldown=0;spawnVoidWave();}
      function tickVoid(dt:number){for(let i=0;i<vgBGs.length;i++){vgBGs[i].x-=vgBGs[i].speed*dt;if(vgBGs[i].x<=-VG_BGW)vgBGs[i].x+=VG_BGW;}const pSpd=200;if(K['ArrowUp']||K['w']||K['W']||K['KeyW'])vgPlayer.y-=pSpd*dt;if(K['ArrowDown']||K['s']||K['S']||K['KeyS'])vgPlayer.y+=pSpd*dt;vgPlayer.y+=(mouseY-vgPlayer.y)*Math.min(1,dt*5);vgPlayer.y=Math.max(20,Math.min(CH-20,vgPlayer.y));if(vgPlayer.iframes>0)vgPlayer.iframes-=dt;vgPlayer.shootTimer-=dt;if(vgPlayer.shootTimer<=0){vgPlayer.shootTimer=0.2;vgBullets.push({x:vgPlayer.x+18,y:vgPlayer.y,vx:500,vy:0,owner:'p'});}for(let i=0;i<vgEnemies.length;i++){const e2=vgEnemies[i];if(e2.dest){e2.destT+=dt;continue;}e2.phase+=dt*(e2.type==='vg_sc'?4:e2.type==='vg_fr'?2.5:1);e2.x+=e2.vx*dt;const yOff=e2.type==='vg_fr'?Math.sin(e2.phase)*55:e2.type==='vg_sc'?Math.sin(e2.phase)*80:0;e2.y=Math.max(20,Math.min(CH-20,e2.y+yOff*dt));e2.fireTimer-=dt;if(e2.fireTimer<=0){e2.fireTimer=1.2+Math.random()*1.5;const ang=Math.atan2(vgPlayer.y-e2.y,vgPlayer.x-e2.x);const bs=e2.type==='vg_dr'?180:220;vgBullets.push({x:e2.x-16,y:e2.y,vx:Math.cos(ang)*bs,vy:Math.sin(ang)*bs,owner:'e'});}}const nb:any[]=[];for(let i=0;i<vgBullets.length;i++){const b=vgBullets[i];b.x+=b.vx*dt;b.y+=b.vy*dt;if(b.x>-10&&b.x<CW+30&&b.y>-10&&b.y<CH+10)nb.push(b);}vgBullets=nb;for(let ei=vgEnemies.length-1;ei>=0;ei--){const e2=vgEnemies[ei];if(e2.dest)continue;const ew=e2.type==='vg_dr'?44:22;for(let bi=vgBullets.length-1;bi>=0;bi--){const b=vgBullets[bi];if(b.owner!=='p')continue;if(Math.abs(b.x-e2.x)<ew&&Math.abs(b.y-e2.y)<ew){vgBullets.splice(bi,1);e2.hp--;if(e2.hp<=0){addScore((e2.type==='vg_sc'?10:e2.type==='vg_fr'?20:50)*vgWave);e2.dest=true;e2.destT=0;}break;}}}vgEnemies=vgEnemies.filter(function(e2:any){if(!e2.dest)return true;const fc=e2.type==='vg_sc'?10:e2.type==='vg_fr'?9:12;return e2.destT<fc*0.08;});if(vgPlayer.iframes<=0){for(let bi=vgBullets.length-1;bi>=0;bi--){const b=vgBullets[bi];if(b.owner!=='e')continue;if(Math.abs(b.x-vgPlayer.x)<18&&Math.abs(b.y-vgPlayer.y)<18){vgBullets.splice(bi,1);lives--;combo=0;vgPlayer.iframes=2.0;updateHUD();if(lives<=0){drawVoid();showOverlay(false);return;}break;}}}const vgAlive=vgEnemies.filter(function(e2:any){return!e2.dest;});if(vgAlive.length===0){vgWaveCooldown-=dt;if(vgWaveCooldown<=0){vgWaveCooldown=2;spawnVoidWave();}}else vgWaveCooldown=2;drawVoid();}
      function drawVoid(){ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,CW,CH);for(let i=0;i<4;i++){const img=IMG[VG_BG_KEYS[i]];if(!img||!img.complete||img.naturalWidth===0)continue;ctx.globalAlpha=0.18+i*0.16;const x0=vgBGs[i].x;ctx.drawImage(img,x0,0,VG_BGW,CH);ctx.drawImage(img,x0+VG_BGW,0,VG_BGW,CH);}ctx.globalAlpha=1;for(let i=0;i<vgBullets.length;i++){const b=vgBullets[i];if(b.owner==='e'){ctx.fillStyle='#f87171';ctx.beginPath();ctx.arc(b.x,b.y,4,0,Math.PI*2);ctx.fill();}}for(let i=0;i<vgEnemies.length;i++){const e2=vgEnemies[i];if(e2.dest){const dk=e2.type==='vg_sc'?'vg_sc_dest':e2.type==='vg_fr'?'vg_fr_dest':'vg_dr_dest';const di=IMG[dk];if(di&&di.complete&&di.naturalWidth>0){const fc=e2.type==='vg_sc'?10:e2.type==='vg_fr'?9:12;const fr=Math.min(Math.floor(e2.destT/0.08),fc-1);const fw=e2.type==='vg_dr'?128:64;const sw2=e2.type==='vg_dr'?44:24;ctx.drawImage(di,fr*fw,0,fw,fw,e2.x-sw2,e2.y-sw2,sw2*2,sw2*2);}continue;}const eim=IMG[e2.type];const sw2=e2.type==='vg_dr'?44:24;if(eim&&eim.complete&&eim.naturalWidth>0){ctx.save();ctx.translate(e2.x,e2.y);ctx.rotate(Math.PI);ctx.drawImage(eim,-sw2,-sw2,sw2*2,sw2*2);ctx.restore();}else{ctx.fillStyle='#f87171';ctx.fillRect(e2.x-sw2,e2.y-sw2,sw2*2,sw2*2);}if(e2.type==='vg_dr'&&e2.hp<e2.maxHp){ctx.fillStyle='#1e1e2e';ctx.fillRect(e2.x-22,e2.y-34,44,5);ctx.fillStyle='#ef4444';ctx.fillRect(e2.x-22,e2.y-34,Math.floor(44*e2.hp/e2.maxHp),5);}}for(let i=0;i<vgBullets.length;i++){const b=vgBullets[i];if(b.owner==='p'){if(IMG.bullet&&IMG.bullet.complete&&IMG.bullet.naturalWidth>0)ctx.drawImage(IMG.bullet,b.x-4,b.y-7,8,14);else{ctx.fillStyle=C2;ctx.fillRect(b.x-2,b.y-5,4,10);}}}if(!(vgPlayer.iframes>0&&Math.floor(vgPlayer.iframes*8)%2===0)){const pim=IMG['vg_player']||IMG.player;if(pim&&pim.complete&&pim.naturalWidth>0)ctx.drawImage(pim,vgPlayer.x-16,vgPlayer.y-16,32,32);else{ctx.fillStyle=C2;ctx.fillRect(vgPlayer.x-8,vgPlayer.y-12,16,24);}}const vgAlive2=vgEnemies.filter(function(e2:any){return!e2.dest;});if(vgAlive2.length===0&&vgWaveCooldown>0&&vgWaveCooldown<1.95){ctx.font='bold 26px monospace';ctx.fillStyle=C2;ctx.textAlign='center';ctx.fillText('WAVE '+vgWave+' CLEAR!',CW/2,CH/2-12);ctx.font='14px monospace';ctx.fillStyle='#64748b';ctx.fillText('Next wave...',CW/2,CH/2+16);ctx.textAlign='left';}}
      // ===== CITY RUNNER =====
      const RN_BG_KEYS=['c3_1','c3_2','c3_3','c3_4','c3_5','c3_6'];const RN_BG_PARS=[0.03,0.08,0.16,0.3,0.55,1.0];
      let rnBGs:any[],rnRunner:any,rnPlatforms:any[],rnObstacles:any[],rnRunSpeed:number,rnDist:number,rnSpawnX:number,rnLastPlatY:number,rnJumps:number,rnDucking:boolean,rnFrame:number,rnFrameT:number;
      function spawnRnPlat(){const gapW=55+Math.random()*80;const platW=80+Math.random()*110;const dy=(Math.random()-0.5)*70;rnLastPlatY=Math.max(CH-210,Math.min(CH-60,rnLastPlatY+dy));rnPlatforms.push({x:rnSpawnX+gapW,y:rnLastPlatY,w:platW,h:16});if(Math.random()<0.38&&platW>60){const oType=Math.random()<0.5?'barrel':'chimney';const oW=oType==='barrel'?22:18;const oH=oType==='barrel'?24:40;rnObstacles.push({x:rnSpawnX+gapW+platW*0.4,y:rnLastPlatY-oH,w:oW,h:oH,type:oType});}rnSpawnX+=gapW+platW;}
      function startRunner(){rnBGs=RN_BG_KEYS.map(function(_:any,i:number){return{x:0,par:RN_BG_PARS[i]};});rnRunSpeed=190;rnDist=0;rnSpawnX=CW+100;rnLastPlatY=CH-60;rnJumps=0;rnDucking=false;rnFrame=0;rnFrameT=0;rnPlatforms=[{x:0,y:CH-50,w:CW+20,h:50}];rnObstacles=[];rnRunner={x:80,y:CH-50-32,vy:0,onGround:true,w:20,h:32};for(let i=0;i<5;i++)spawnRnPlat();}
      function tickRunner(dt:number){rnDist+=rnRunSpeed*dt;if(rnDist>300)rnRunSpeed=Math.min(rnRunSpeed+6*dt,400);const scroll=rnRunSpeed*dt;for(let i=0;i<rnBGs.length;i++)rnBGs[i].x+=scroll*rnBGs[i].par;for(let i=0;i<rnPlatforms.length;i++)rnPlatforms[i].x-=scroll;for(let i=0;i<rnObstacles.length;i++)rnObstacles[i].x-=scroll;rnSpawnX-=scroll;while(rnSpawnX<CW+320)spawnRnPlat();rnPlatforms=rnPlatforms.filter(function(p:any){return p.x+p.w>-60;});rnObstacles=rnObstacles.filter(function(o:any){return o.x+o.w>-60;});const jumpKey=!!(K['ArrowUp']||K[' ']||K['Space']||K['w']||K['W']||K['KeyW']);const duckKey=!!(K['ArrowDown']||K['s']||K['S']||K['KeyS']);rnDucking=!!(duckKey&&rnRunner.onGround);const rh=rnDucking?18:32;rnRunner.h=rh;if(jumpKey&&rnJumps<2){rnRunner.vy=-490;rnRunner.onGround=false;rnJumps++;K['ArrowUp']=false;K[' ']=false;K['Space']=false;K['w']=false;K['W']=false;K['KeyW']=false;}rnRunner.vy+=1100*dt;rnRunner.y+=rnRunner.vy*dt;rnRunner.onGround=false;for(let i=0;i<rnPlatforms.length;i++){const p=rnPlatforms[i];if(rnRunner.x+rnRunner.w/2>p.x&&rnRunner.x-rnRunner.w/2<p.x+p.w&&rnRunner.vy>=0&&rnRunner.y+rh>=p.y&&rnRunner.y+rh<=p.y+p.h+14){rnRunner.y=p.y-rh;rnRunner.vy=0;rnRunner.onGround=true;rnJumps=0;break;}}if(rnRunner.y>CH+50){drawRunner();showOverlay(false);return;}for(let i=0;i<rnObstacles.length;i++){const o=rnObstacles[i];if(!rnDucking&&rnRunner.x+rnRunner.w/2>o.x&&rnRunner.x-rnRunner.w/2<o.x+o.w&&rnRunner.y+rh>o.y&&rnRunner.y<o.y+o.h){lives--;combo=0;updateHUD();rnObstacles.splice(i,1);if(lives<=0){drawRunner();showOverlay(false);return;}break;}}if(rnRunner.onGround&&!rnDucking){rnFrameT+=dt*rnRunSpeed/80;if(rnFrameT>0.12){rnFrameT=0;rnFrame=(rnFrame+1)%4;}}score+=Math.max(1,Math.floor(rnRunSpeed*dt));if(score>hiScore){hiScore=score;localStorage.setItem(HI_SCORE_KEY,String(hiScore));}updateHUD();drawRunner();}
      function drawRunner(){ctx.fillStyle='#0d0d18';ctx.fillRect(0,0,CW,CH);for(let i=0;i<RN_BG_KEYS.length;i++){const img=IMG[RN_BG_KEYS[i]];if(!img||!img.complete||img.naturalWidth===0)continue;ctx.globalAlpha=0.12+i*0.13;const bx=-(rnBGs[i].x%VG_BGW);ctx.drawImage(img,bx,0,VG_BGW,CH);ctx.drawImage(img,bx+VG_BGW,0,VG_BGW,CH);ctx.drawImage(img,bx+VG_BGW*2,0,VG_BGW,CH);}ctx.globalAlpha=1;for(let i=0;i<rnPlatforms.length;i++){const p=rnPlatforms[i];ctx.fillStyle=p.h>30?'#1a1a2e':'#252540';ctx.fillRect(p.x,p.y,p.w,p.h);ctx.fillStyle='#3a3a60';ctx.fillRect(p.x,p.y,p.w,3);}for(let i=0;i<rnObstacles.length;i++){const o=rnObstacles[i];if(o.type==='barrel'){ctx.fillStyle='#92400e';ctx.fillRect(o.x,o.y,o.w,o.h);ctx.fillStyle='#78350f';ctx.fillRect(o.x,o.y+o.h*0.25,o.w,3);ctx.fillRect(o.x,o.y+o.h*0.65,o.w,3);}else{ctx.fillStyle='#374151';ctx.fillRect(o.x,o.y,o.w,o.h);ctx.fillStyle='#6b7280';ctx.fillRect(o.x+o.w/2-4,o.y,8,8);}}const rx=rnRunner.x,ry=rnRunner.y,rh=rnRunner.h,rw=rnRunner.w;if(rnDucking){ctx.fillStyle=C2;ctx.fillRect(rx-rw/2,ry+rh-18,rw,18);ctx.fillStyle='#f8fafc';ctx.fillRect(rx-6,ry+rh-18,12,10);}else{ctx.fillStyle=C1;ctx.fillRect(rx-rw/2,ry+8,rw,rh-16);ctx.fillStyle='#f8fafc';ctx.fillRect(rx-8,ry,16,14);const lg=Math.sin(rnFrame*Math.PI/2)*5;ctx.fillStyle=C3;ctx.fillRect(rx-rw/2,ry+rh-8+lg,8,8);ctx.fillRect(rx+2,ry+rh-8-lg,8,8);}ctx.fillStyle=C2;ctx.font='bold 12px monospace';ctx.fillText('DIST '+Math.floor(rnDist/80)+'m   SPD '+Math.floor(rnRunSpeed),8,22);}
      // ===== ASTEROIDS =====
      function makeRock(x:number,y:number,tier:number,vx:number,vy:number):any{const radii=[65,38,18];const r=radii[tier];const vn=8+Math.floor(Math.random()*5);const pts:number[][]=[];for(let i=0;i<vn;i++){const a=(i/vn)*Math.PI*2;const n=r*(0.72+Math.random()*0.56);pts.push([Math.cos(a)*n,Math.sin(a)*n]);}return{x,y,vx,vy,r,tier,pts,rot:0,rotV:(Math.random()-0.5)*1.8};}
      let astPlayer:any,astBullets:any[],astRocks:any[],astParticles:any[],astWave:number,astShootCd:number,astThrust:boolean;
      function spawnAstWave(){astWave++;const n=3+astWave;for(let i=0;i<n;i++){const edge=Math.floor(Math.random()*4);let rx:number,ry:number;if(edge===0){rx=Math.random()*CW;ry=-70;}else if(edge===1){rx=CW+70;ry=Math.random()*CH;}else if(edge===2){rx=Math.random()*CW;ry=CH+70;}else{rx=-70;ry=Math.random()*CH;}const ang=Math.atan2(CH/2-ry,CW/2-rx)+(Math.random()-0.5)*1.0;const spd=28+Math.random()*32;astRocks.push(makeRock(rx,ry,0,Math.cos(ang)*spd,Math.sin(ang)*spd));}}
      function startAsteroids(){astPlayer={x:CW/2,y:CH/2,vx:0,vy:0,angle:-Math.PI/2,iframes:0};astBullets=[];astRocks=[];astParticles=[];astWave=0;astShootCd=0;astThrust=false;spawnAstWave();}
      function tickAsteroids(dt:number){if(K['ArrowLeft']||K['a']||K['A']||K['KeyA'])astPlayer.angle-=3.2*dt;if(K['ArrowRight']||K['d']||K['D']||K['KeyD'])astPlayer.angle+=3.2*dt;astThrust=!!(K['ArrowUp']||K['w']||K['W']||K['KeyW']);if(astThrust){astPlayer.vx+=Math.cos(astPlayer.angle)*280*dt;astPlayer.vy+=Math.sin(astPlayer.angle)*280*dt;}const spd2=Math.sqrt(astPlayer.vx*astPlayer.vx+astPlayer.vy*astPlayer.vy);if(spd2>360){astPlayer.vx*=360/spd2;astPlayer.vy*=360/spd2;}astPlayer.vx*=Math.pow(0.985,dt*60);astPlayer.vy*=Math.pow(0.985,dt*60);astPlayer.x=((astPlayer.x+astPlayer.vx*dt)%CW+CW)%CW;astPlayer.y=((astPlayer.y+astPlayer.vy*dt)%CH+CH)%CH;if(astPlayer.iframes>0)astPlayer.iframes-=dt;astShootCd-=dt;if((K[' ']||K['Space'])&&astShootCd<=0&&astBullets.length<8){astShootCd=0.28;astBullets.push({x:astPlayer.x+Math.cos(astPlayer.angle)*18,y:astPlayer.y+Math.sin(astPlayer.angle)*18,vx:Math.cos(astPlayer.angle)*520+astPlayer.vx,vy:Math.sin(astPlayer.angle)*520+astPlayer.vy,life:1.6});}const nbA:any[]=[];for(let i=0;i<astBullets.length;i++){const b=astBullets[i];b.x=((b.x+b.vx*dt)%CW+CW)%CW;b.y=((b.y+b.vy*dt)%CH+CH)%CH;b.life-=dt;if(b.life>0)nbA.push(b);}astBullets=nbA;for(let i=0;i<astRocks.length;i++){const rock=astRocks[i];rock.x=((rock.x+rock.vx*dt)%CW+CW)%CW;rock.y=((rock.y+rock.vy*dt)%CH+CH)%CH;rock.rot+=rock.rotV*dt;}const np:any[]=[];for(let i=0;i<astParticles.length;i++){const p=astParticles[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;if(p.life>0)np.push(p);}astParticles=np;if(astThrust&&Math.random()<0.6){const ba=astPlayer.angle+Math.PI+(Math.random()-0.5)*0.6;astParticles.push({x:astPlayer.x,y:astPlayer.y,vx:Math.cos(ba)*80+astPlayer.vx*0.2,vy:Math.sin(ba)*80+astPlayer.vy*0.2,life:0.28,color:C3});}const newRocks:any[]=[];const usedB:Set<any>=new Set();for(let ri=0;ri<astRocks.length;ri++){const rock=astRocks[ri];let hit=false;for(let bi=0;bi<astBullets.length;bi++){if(usedB.has(bi))continue;const b=astBullets[bi];const dx=b.x-rock.x,dy=b.y-rock.y;if(Math.sqrt(dx*dx+dy*dy)<rock.r){hit=true;usedB.add(bi);addScore([20,50,100][rock.tier]);for(let k=0;k<5;k++){const pa=Math.random()*Math.PI*2;const ps=35+Math.random()*55;astParticles.push({x:rock.x,y:rock.y,vx:Math.cos(pa)*ps,vy:Math.sin(pa)*ps,life:0.4+Math.random()*0.3,color:k%2===0?C1:C3});}if(rock.tier<2){for(let c=0;c<2;c++){const ca=Math.random()*Math.PI*2;const cs=42+Math.random()*38;newRocks.push(makeRock(rock.x+(Math.random()-0.5)*16,rock.y+(Math.random()-0.5)*16,rock.tier+1,Math.cos(ca)*cs,Math.sin(ca)*cs));}}break;}}if(!hit)newRocks.push(rock);}astBullets=astBullets.filter(function(_:any,bi:number){return!usedB.has(bi);});astRocks=newRocks;if(astPlayer.iframes<=0){for(let ri=0;ri<astRocks.length;ri++){const rock=astRocks[ri];const dx=astPlayer.x-rock.x,dy=astPlayer.y-rock.y;if(Math.sqrt(dx*dx+dy*dy)<rock.r-5){lives--;combo=0;astPlayer.iframes=2.5;astPlayer.vx=0;astPlayer.vy=0;updateHUD();if(lives<=0){drawAsteroids();showOverlay(false);return;}break;}}}if(astRocks.length===0){addScore(500);spawnAstWave();}drawAsteroids();}
      function drawAsteroids(){ctx.fillStyle='#05050f';ctx.fillRect(0,0,CW,CH);ctx.fillStyle='rgba(255,255,255,0.45)';for(let i=0;i<60;i++){const sx=((i*73+astPlayer.x*0.04)%CW+CW)%CW;const sy=((i*137+astPlayer.y*0.04)%CH+CH)%CH;ctx.fillRect(sx,sy,i%4===0?2:1,i%4===0?2:1);}for(let i=0;i<astParticles.length;i++){const p=astParticles[i];ctx.globalAlpha=Math.max(0,p.life*2);ctx.fillStyle=p.color;ctx.fillRect(p.x-2,p.y-2,4,4);}ctx.globalAlpha=1;for(let i=0;i<astRocks.length;i++){const rock=astRocks[i];ctx.save();ctx.translate(rock.x,rock.y);ctx.rotate(rock.rot);ctx.strokeStyle='#94a3b8';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(rock.pts[0][0],rock.pts[0][1]);for(let j=1;j<rock.pts.length;j++)ctx.lineTo(rock.pts[j][0],rock.pts[j][1]);ctx.closePath();ctx.stroke();ctx.restore();}for(let i=0;i<astBullets.length;i++){const b=astBullets[i];if(IMG.bullet&&IMG.bullet.complete&&IMG.bullet.naturalWidth>0){ctx.save();ctx.translate(b.x,b.y);ctx.rotate(astPlayer.angle-Math.PI/2);ctx.drawImage(IMG.bullet,-4,-7,8,14);ctx.restore();}else{ctx.fillStyle=C2;ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();}}if(!(astPlayer.iframes>0&&Math.floor(astPlayer.iframes*8)%2===0)){const pim=IMG['vg_sc']||IMG.player;if(pim&&pim.complete&&pim.naturalWidth>0){ctx.save();ctx.translate(astPlayer.x,astPlayer.y);ctx.rotate(astPlayer.angle+Math.PI/2);ctx.drawImage(pim,-16,-16,32,32);ctx.restore();}else{ctx.save();ctx.translate(astPlayer.x,astPlayer.y);ctx.rotate(astPlayer.angle);ctx.fillStyle=C2;ctx.beginPath();ctx.moveTo(16,0);ctx.lineTo(-12,10);ctx.lineTo(-8,0);ctx.lineTo(-12,-10);ctx.closePath();ctx.fill();ctx.restore();}if(astThrust){ctx.save();ctx.translate(astPlayer.x,astPlayer.y);ctx.rotate(astPlayer.angle);ctx.globalAlpha=0.6+Math.random()*0.4;ctx.fillStyle=C3;ctx.beginPath();ctx.moveTo(-8,0);ctx.lineTo(-18,7);ctx.lineTo(-26,0);ctx.lineTo(-18,-7);ctx.closePath();ctx.fill();ctx.globalAlpha=1;ctx.restore();}}ctx.fillStyle='#475569';ctx.font='bold 12px monospace';ctx.fillText('WAVE '+astWave,8,22);}
      // ===== NES EMULATOR (JSNES â€” random game from nes-games.json manifest) =====
      let nesEmu:any=null,nesImgData:ImageData|null=null,nesPixels:Uint8ClampedArray|null=null,nesTempCanvas:HTMLCanvasElement|null=null,nesTempCtx:CanvasRenderingContext2D|null=null,nesLoaded:boolean=false,nesLoadErr:string='',nesRomFile:string='cartridge.nes',nesGameName:string='';
      function initNesEmu(){nesEmu=new (window as any).jsnes.NES({onFrame:function(buf:number[]){if(!nesPixels)return;for(let i=0;i<256*240;i++){const c=buf[i];const p=i*4;nesPixels[p]=(c>>16)&0xFF;nesPixels[p+1]=(c>>8)&0xFF;nesPixels[p+2]=c&0xFF;nesPixels[p+3]=0xFF;}},onAudioSample:null as any,emulateSound:false});fetch('/'+nesRomFile).then(function(r:Response){if(!r.ok)throw new Error('404');return r.arrayBuffer();}).then(function(buf2:ArrayBuffer){const bytes=new Uint8Array(buf2);let str='';for(let i=0;i<bytes.length;i++)str+=String.fromCharCode(bytes[i]);nesEmu.loadROM(str);nesLoaded=true;}).catch(function(){nesLoadErr='ROM load failed';});}
      function startNes(){nesLoaded=false;nesLoadErr='';nesGameName='';nesTempCanvas=document.createElement('canvas');nesTempCanvas.width=256;nesTempCanvas.height=240;nesTempCtx=nesTempCanvas.getContext('2d');if(nesTempCtx){nesImgData=nesTempCtx.createImageData(256,240);nesPixels=nesImgData.data;}fetch('/nes-games.json').then(function(r:Response){return r.ok?r.json():Promise.reject();}).then(function(list:string[]){if(Array.isArray(list)&&list.length>0){nesRomFile=list[Math.floor(Math.random()*list.length)];nesGameName=nesRomFile.replace(/\s*\(U\).*$/,'').replace(/\.nes$/i,'').trim();}else{nesRomFile='cartridge.nes';}loadJsnes();}).catch(function(){nesRomFile='cartridge.nes';loadJsnes();});}
      function loadJsnes(){if(typeof (window as any).jsnes==='undefined'){let sc=document.getElementById('jsnes-sc') as HTMLScriptElement|null;if(!sc){sc=document.createElement('script') as HTMLScriptElement;sc.id='jsnes-sc';sc.src='/jsnes.min.js';sc.onload=function(){if(typeof (window as any).jsnes!=='undefined')initNesEmu();else nesLoadErr='Emulator load failed';};sc.onerror=function(){nesLoadErr='Emulator load failed';};document.head.appendChild(sc);}}else{initNesEmu();}}
      function tickNes(_dt:number){if(!nesLoaded){drawNes();return;}const J=(window as any).jsnes.Controller;const btn=(b:number,down:boolean)=>{if(down)nesEmu.buttonDown(1,b);else nesEmu.buttonUp(1,b);};btn(J.BUTTON_UP,!!(K['ArrowUp']));btn(J.BUTTON_DOWN,!!(K['ArrowDown']));btn(J.BUTTON_LEFT,!!(K['ArrowLeft']));btn(J.BUTTON_RIGHT,!!(K['ArrowRight']));btn(J.BUTTON_A,!!(K['z']||K['Z']));btn(J.BUTTON_B,!!(K['x']||K['X']));btn(J.BUTTON_START,!!(K['Enter']));btn(J.BUTTON_SELECT,!!(K['Shift']));nesEmu.frame();drawNes();}
      function drawNes(){if(nesLoadErr){ctx.fillStyle='#000';ctx.fillRect(0,0,CW,CH);ctx.fillStyle=C1;ctx.font='bold 16px monospace';ctx.textAlign='center';ctx.fillText(nesLoadErr,CW/2,CH/2);ctx.textAlign='left';return;}if(!nesLoaded){ctx.fillStyle='#000';ctx.fillRect(0,0,CW,CH);ctx.fillStyle=C2;ctx.font='bold 14px monospace';ctx.textAlign='center';ctx.fillText('Loading NES...',CW/2,CH/2-12);if(nesGameName){ctx.fillStyle=C3;ctx.font='11px monospace';ctx.fillText(nesGameName,CW/2,CH/2+12);}ctx.textAlign='left';return;}if(nesTempCtx&&nesImgData&&nesTempCanvas){nesTempCtx.putImageData(nesImgData,0,0);ctx.imageSmoothingEnabled=false;ctx.drawImage(nesTempCanvas,0,0,256,240,0,24,480,432);}}
      updateHUD();
    });

    return () => { mounted=false;if(raf!==null){cancelAnimationFrame(raf);raf=null;}document.removeEventListener('keydown',onKeyDown as EventListener);document.removeEventListener('keyup',onKeyUp as EventListener); };
  }, []);

  return (
    <>
      <link rel="preconnect" href="https://fonts.googleapis.com" />
      <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="" />
      <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
      <style dangerouslySetInnerHTML={{__html: nfCss}} />
      <div style={{display:'flex',flexDirection:'column',alignItems:'center',padding:'80px 12px 32px',minHeight:'60vh'}}>
        <header style={{width:'100%',maxWidth:'540px',padding:'20px 0 10px',display:'flex',flexDirection:'column',alignItems:'center',gap:'6px'}}>
          <div className="nf-err-code">404</div>
          <p className="nf-tagline">Page not found &mdash; play a game while you&apos;re here</p>
        </header>
        <div id="nf-game-wrap">
          <div id="nf-hud"><span id="nf-s-score">SCORE 0</span><span id="nf-s-lives"></span><span id="nf-s-hi">BEST 0</span></div>
          <canvas id="nf-gc" />
          <p id="nf-game-hint" />
          <button id="nf-sw-game">&#8635; SWITCH GAME</button>
          <div id="nf-overlay">
            <div id="nf-ov-box">
              <div id="nf-ov-title">GAME OVER</div>
              <div id="nf-ov-score" />
              <div id="nf-ov-hi" className="nf-ov-hi" />
              <div id="nf-ov-scores" />
              <button id="nf-ov-play">PLAY AGAIN</button>
              <a href="/" id="nf-ov-home">Go Home</a>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}
